<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casa Wilson - Story Buddy</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Nunito:wght@300;400;600;700;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Nunito', sans-serif;
            background: #FFFEF7;
            color: #1A1A2E;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header {
            text-align: center;
            padding: 30px 20px 10px;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5rem;
            background: linear-gradient(135deg, #1B5E20, #FFD700, #1B5E20);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            color: #2E7D32;
            font-style: italic;
            letter-spacing: 1.5px;
            margin-top: -4px;
        }

        .story-buddy-title {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            color: #1B5E20;
            text-align: center;
            margin-top: 20px;
        }

        .story-buddy-sub {
            color: #FFD700;
            text-align: center;
            font-weight: 700;
            letter-spacing: 2px;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        /* Main voice area */
        .voice-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            width: 100%;
            max-width: 500px;
        }

        /* Big mic button */
        .mic-btn {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #1B5E20, #2E7D32);
            color: white;
            font-size: 60px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 30px rgba(27, 94, 32, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .mic-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 40px rgba(27, 94, 32, 0.4);
        }

        .mic-btn.listening {
            background: linear-gradient(135deg, #C62828, #E53935);
            animation: pulse 1.5s ease-in-out infinite;
            box-shadow: 0 8px 30px rgba(198, 40, 40, 0.4);
        }

        .mic-btn.speaking {
            background: linear-gradient(135deg, #FFD700, #FFC107);
            animation: glow 1s ease-in-out infinite;
            box-shadow: 0 8px 30px rgba(255, 215, 0, 0.4);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 8px 30px rgba(255, 215, 0, 0.4); }
            50% { box-shadow: 0 12px 50px rgba(255, 215, 0, 0.7); }
        }

        .status {
            margin-top: 24px;
            font-size: 1.2rem;
            font-weight: 700;
            color: #1B5E20;
            text-align: center;
            min-height: 30px;
        }

        .transcript {
            margin-top: 16px;
            padding: 16px 24px;
            background: #F0F7F0;
            border-radius: 12px;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            font-size: 1rem;
            line-height: 1.6;
            color: #333;
        }

        .transcript .user { color: #1B5E20; font-weight: 700; }
        .transcript .buddy { color: #B8860B; font-weight: 700; }
        .transcript p { margin-bottom: 8px; }

        /* Kid select buttons */
        .kid-select {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
        }

        .kid-btn {
            padding: 20px 16px;
            border: 2px solid #1B5E20;
            border-radius: 12px;
            background: white;
            font-family: 'Nunito', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            color: #1B5E20;
            cursor: pointer;
            transition: all 0.2s;
        }

        .kid-btn:hover {
            background: #1B5E20;
            color: #FFD700;
        }

        .kid-btn small {
            display: block;
            font-weight: 400;
            font-size: 0.8rem;
            margin-top: 4px;
            opacity: 0.7;
        }

        .footer {
            padding: 16px;
            text-align: center;
            color: #999;
            font-size: 0.8rem;
        }

        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>Casa Wilson</h1>
        <p>Irish Roots. Disney Magic. Wilson Strong.</p>
    </div>

    <div class="story-buddy-title">Story Buddy</div>
    <div class="story-buddy-sub">KA-CHOW! THWIP! LET'S GO!</div>

    <!-- Kid Selection Screen -->
    <div id="kid-select-screen" class="voice-area">
        <p style="font-size: 1.1rem; margin-bottom: 16px; font-weight: 600;">Who's here for story time?</p>
        <div class="kid-select">
            <button class="kid-btn" onclick="startSession('liam')">
                LIAM<small>Cars / SpongeBob</small>
            </button>
            <button class="kid-btn" onclick="startSession('logan')">
                LOGAN<small>Spider-Man</small>
            </button>
            <button class="kid-btn" onclick="startSession('both')">
                BOTH BOYS<small>Crossover Mode</small>
            </button>
            <button class="kid-btn" onclick="startSession('demo')">
                DEMO<small>Show Me How</small>
            </button>
        </div>
    </div>

    <!-- Voice Conversation Screen -->
    <div id="voice-screen" class="voice-area hidden">
        <button id="mic-btn" class="mic-btn" onclick="startMicOnce()">
            üéôÔ∏è
        </button>
        <div id="status" class="status">Tap the mic to start story time</div>
        <div id="transcript" class="transcript">
            <p style="color: #999; font-style: italic;">Story Buddy is ready...</p>
        </div>
    </div>

    <div class="footer">
        Casa Wilson v2.0 | Built by Uncle Peter | Powered by Sinton.ia
    </div>

    <script>
        let ws = null;
        let audioContext = null;
        let mediaStream = null;
        let scriptProcessor = null;
        let isListening = false;
        let isSpeaking = false;
        let audioQueue = [];
        let isPlaying = false;
        let persistentAudio = null; // Reusable audio element for mobile

        const micBtn = document.getElementById('mic-btn');
        const statusEl = document.getElementById('status');
        const transcriptEl = document.getElementById('transcript');

        function startSession(kid) {
            // Unlock audio on mobile - must happen in user gesture
            persistentAudio = new Audio();
            persistentAudio.src = 'data:audio/mp3;base64,SUQzBAAAAAAAI1RTU0UAAAAPAAADTGF2ZjU4Ljc2LjEwMAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYoRBqSAAAAAAAAAAAAAAAAAAAA//tQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAWGluZwAAAA8AAAACAAABhgC7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7u7//////////////////////////////////////////////////////////////////8AAAAATGF2YzU4LjEzAAAAAAAAAAAAAAAAJAAAAAAAAAAAAYYoRBqSAAAAAAAAAAAAAAAAAAAA';
            persistentAudio.play().then(() => { persistentAudio.pause(); }).catch(() => {});

            document.getElementById('kid-select-screen').classList.add('hidden');
            document.getElementById('voice-screen').classList.remove('hidden');

            // Connect WebSocket
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${window.location.host}/ws`);

            ws.onopen = () => {
                statusEl.textContent = 'Connected! Tap the mic to talk.';

                // Send initial message based on kid selection
                let initMsg = '';
                if (kid === 'liam') initMsg = "Liam is here! He's ready for a story.";
                else if (kid === 'logan') initMsg = "Logan is here! He's ready for a story.";
                else if (kid === 'both') initMsg = "Both Liam and Logan are here! Crossover time!";
                else initMsg = "Demo mode! Show me how Story Buddy works.";

                // Send as text conversation item
                ws.send(JSON.stringify({
                    type: "conversation.item.create",
                    item: {
                        type: "message",
                        role: "user",
                        content: [{ type: "input_text", text: initMsg }]
                    }
                }));
                ws.send(JSON.stringify({ type: "response.create" }));
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                handleAzureEvent(msg);
            };

            ws.onerror = (err) => {
                statusEl.textContent = 'Connection error. Refresh to try again.';
            };

            ws.onclose = () => {
                statusEl.textContent = 'Disconnected.';
                stopListening();
            };
        }

        function handleAzureEvent(event) {
            switch (event.type) {
                case 'session.created':
                    console.log('Session created');
                    break;

                case 'response.audio.delta':
                    // PCM audio (Azure direct) - queue for playback
                    if (!isSpeaking) {
                        isSpeaking = true;
                        micBtn.classList.remove('listening');
                        micBtn.classList.add('speaking');
                        statusEl.textContent = 'Story Buddy is talking...';
                    }
                    const audioData = base64ToArrayBuffer(event.delta);
                    audioQueue.push(audioData);
                    playAudioQueue();
                    break;

                case 'response.audio.done':
                    // Audio finished
                    break;

                case 'custom.audio.mp3':
                    // Uncle Peter's voice as mp3
                    isSpeaking = true;
                    micBtn.classList.remove('listening');
                    micBtn.classList.add('speaking');
                    statusEl.textContent = 'Uncle Peter is talking...';
                    playMp3(event.audio);
                    break;

                case 'response.audio_transcript.delta':
                    // Show what Story Buddy is saying
                    if (!document.getElementById('current-buddy')) {
                        transcriptEl.innerHTML += '<p id="current-buddy" class="buddy">üìñ </p>';
                    }
                    document.getElementById('current-buddy').textContent += event.delta;
                    transcriptEl.scrollTop = transcriptEl.scrollHeight;
                    break;

                case 'response.audio_transcript.done':
                    const el = document.getElementById('current-buddy');
                    if (el) el.removeAttribute('id');
                    break;

                case 'response.done':
                    setTimeout(() => {
                        isSpeaking = false;
                        micBtn.classList.remove('speaking');
                        if (isListening) {
                            micBtn.classList.add('listening');
                            statusEl.textContent = 'Your turn! Just talk.';
                        }
                    }, 500);
                    break;

                case 'input_audio_buffer.speech_started':
                    statusEl.textContent = 'Listening...';
                    break;

                case 'input_audio_buffer.speech_stopped':
                    statusEl.textContent = 'Thinking...';
                    break;

                case 'conversation.item.input_audio_transcription.completed':
                    // Show what the user said
                    if (event.transcript && event.transcript.trim()) {
                        transcriptEl.innerHTML += `<p class="user">‚òòÔ∏è ${event.transcript}</p>`;
                        transcriptEl.scrollTop = transcriptEl.scrollHeight;
                    }
                    break;

                case 'error':
                    console.error('Azure error:', event.error);
                    statusEl.textContent = 'Oops! Try again.';
                    break;
            }
        }

        async function startMicOnce() {
            if (isListening) return; // Already on, do nothing
            await startListening();
        }

        async function startListening() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 24000
                });

                mediaStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 24000,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                const source = audioContext.createMediaStreamSource(mediaStream);
                scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

                scriptProcessor.onaudioprocess = (e) => {
                    if (!isListening || isSpeaking || !ws || ws.readyState !== WebSocket.OPEN) return;

                    const inputData = e.inputBuffer.getChannelData(0);
                    // Convert float32 to int16
                    const pcm16 = new Int16Array(inputData.length);
                    for (let i = 0; i < inputData.length; i++) {
                        const s = Math.max(-1, Math.min(1, inputData[i]));
                        pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
                    }

                    // Send as base64
                    const b64 = arrayBufferToBase64(pcm16.buffer);
                    ws.send(JSON.stringify({
                        type: "input_audio_buffer.append",
                        audio: b64
                    }));
                };

                source.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                isListening = true;
                micBtn.classList.add('listening');
                micBtn.innerHTML = 'üî¥';
                statusEl.textContent = 'Mic is on. Just talk!';
            } catch (err) {
                statusEl.textContent = 'Mic access denied. Check permissions.';
                console.error(err);
            }
        }

        function stopListening() {
            isListening = false;
            micBtn.classList.remove('listening');

            if (scriptProcessor) {
                scriptProcessor.disconnect();
                scriptProcessor = null;
            }
            if (mediaStream) {
                mediaStream.getTracks().forEach(t => t.stop());
                mediaStream = null;
            }
            if (audioContext && audioContext.state !== 'closed') {
                audioContext.close();
                audioContext = null;
            }
            statusEl.textContent = 'Mic off. Tap to talk again.';
        }

        // Audio playback
        let playbackContext = null;

        function playAudioQueue() {
            if (isPlaying || audioQueue.length === 0) return;
            isPlaying = true;

            if (!playbackContext) {
                playbackContext = new (window.AudioContext || window.webkitAudioContext)({
                    sampleRate: 24000
                });
            }

            function playNext() {
                if (audioQueue.length === 0) {
                    isPlaying = false;
                    return;
                }

                const data = audioQueue.shift();
                const int16 = new Int16Array(data);
                const float32 = new Float32Array(int16.length);
                for (let i = 0; i < int16.length; i++) {
                    float32[i] = int16[i] / 0x8000;
                }

                const buffer = playbackContext.createBuffer(1, float32.length, 24000);
                buffer.getChannelData(0).set(float32);

                const source = playbackContext.createBufferSource();
                source.buffer = buffer;
                source.connect(playbackContext.destination);
                source.onended = playNext;
                source.start();
            }

            playNext();
        }

        // Play mp3 from base64 (Uncle Peter's voice)
        function playMp3(b64) {
            const binary = atob(b64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            const blob = new Blob([bytes.buffer], { type: 'audio/mp3' });
            const url = URL.createObjectURL(blob);
            // Reuse persistent audio element (unlocked on mobile)
            const audio = persistentAudio || new Audio();
            audio.src = url;
            audio.onended = () => {
                isSpeaking = false;
                micBtn.classList.remove('speaking');
                if (isListening) {
                    micBtn.classList.add('listening');
                    statusEl.textContent = 'Your turn! Just talk.';
                }
                URL.revokeObjectURL(url);
            };
            audio.play().catch(err => {
                console.error('Audio play error:', err);
                isSpeaking = false;
                micBtn.classList.remove('speaking');
            });
        }

        // Utility functions
        function base64ToArrayBuffer(base64) {
            const binary = atob(base64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function arrayBufferToBase64(buffer) {
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
    </script>
</body>
</html>
